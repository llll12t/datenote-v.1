<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกเวลา</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        window.onload = async function () {
            await initializeLiff();
            await fetchData();
            document.getElementById('userId').addEventListener('input', debounce(searchData, 300));
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2002290922-O7vx3Jj7' });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (error) {
                console.error('Error initializing LIFF:', error);
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbx8UxgdLUbIjz6L7VCpkLbce3XoOXr1qTpykTo_Cw9yr7cYb8hIXAV_QvNq6lCvEiDxFw/exec', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetchData' })
                });
                const data = await response.json();
                displayData(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function displayData(values) {
            const table = document.getElementById('data-table');
            table.innerHTML = ''; // Clear previous data
            values.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        function searchData() {
            const searchInput = document.getElementById('userId').value.toUpperCase();
            const table = document.getElementById('data-table');
            const rows = table.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent || cells[j].innerText;
                    if (cellText.toUpperCase().includes(searchInput)) {
                        match = true;
                        break;
                    }
                }

                rows[i].style.display = match ? '' : 'none';
                if (match) {
                    updateInputFields(rows[i]);
                }
            }
        }

        function updateInputFields(row) {
            const columns = row.getElementsByTagName('td');
            document.getElementById('columnAData').value = columns[0].textContent || '';
            document.getElementById('columnBData').value = columns[1].textContent || '';
            document.getElementById('roleInput').value = columns[2].textContent || '';
            document.getElementById('columnDData').value = columns[3].textContent || '';
        }
    </script>
</head>
<body>
    <div class="container buttom-content">
        <div id="step1">
            <div class="state p-2">
                <div class="input-icons">
                    <span class="material-symbols-outlined">co_present</span>
                    <input type="text" class="input-field" id="columnBData" placeholder="ชื่อ - สกุล" name="columnBData" required>
                </div>
                <div class="input-icons">
                    <span class="material-symbols-outlined">pin</span>
                    <input type="text" class="input-field" id="roleInput" placeholder="รหัส พนักงาน" name="roleInput" required>
                </div>
                <div class="input-icons">
                    <span class="material-symbols-outlined">editor_choice</span>
                    <input type="text" class="input-field" id="columnDData" placeholder="ตำแหน่ง" name="columnDData" required>
                </div>
                <input type="text" id="userId" name="userId" placeholder="ค้นหา" style="visibility: visible;" />
                <table id="data-table" style="visibility: visible;"></table>
                <input type="hidden" id="columnAData" name="columnAData">
            </div>
        </div>
    </div>
</body>
</html>
