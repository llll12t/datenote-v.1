<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติ การบันทึก</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>

<style>
    /* Your existing styles here... */
</style>

<script>
    let inputEventCounter = 0;
    const itemsPerPage = 20;
    let currentPage = 1;

    async function initializeLiff() {
        await liff.init({ liffId: '2002290922-yOznjZkQ' });

        if (liff.isLoggedIn()) {
            getUserProfile();
        } else {
            liff.login();
        }
    }

    async function getUserProfile() {
        try {
            const profile = await liff.getProfile();
            document.getElementById('userId').value = profile.userId;

            fetchData('data-table'); // Fetch data from the Google Sheets for data-table
            fetchData('additional-table'); // Fetch data from the Google Sheets for additional-table
            searchData('data-table'); // Perform initial search and display data for data-table
        } catch (error) {
            console.error('Error getting profile data:', error);
        }
    }

    async function fetchData(tableId) {
        try {
            const values = await fetchValues();
            const filteredValues = filterData(values);
            buildTable(tableId, filteredValues);
            buildAdditionalTable('additional-table', filteredValues);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    function buildAdditionalTable(tableId, values) {
        const table = document.getElementById(tableId);
        table.innerHTML = '';

        const row = values[0];
        const tr = document.createElement('tr');

        for (let cellIndex = 2; cellIndex <= 3; cellIndex++) {
            const td = document.createElement('td');
            td.textContent = row[cellIndex];

            tr.appendChild(td);
        }

        table.appendChild(tr);
    }

    function buildTable(tableId, values) {
        const table = document.getElementById(tableId);
        table.innerHTML = '';

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        const reversedValues = values.slice().reverse();

        reversedValues.slice(startIndex, endIndex).forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            row.forEach((cell, cellIndex) => {
                const td = document.createElement('td');
                td.textContent = cell;

                const hiddenColumns = [0, 1, 2, 3, 8, 9, 10, 11];
                if (hiddenColumns.includes(cellIndex)) {
                    td.style.display = 'none';
                }

                tr.appendChild(td);
            });

            if (rowIndex === 6) {
                tr.style.display = 'none';
            }

            table.appendChild(tr);
        });

        updatePaginationControls(values.length);
    }

    function updatePaginationControls(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.addEventListener('click', () => {
                currentPage = i;
                fetchData('data-table');
            });

            if (i === currentPage) {
                pageButton.classList.add('active');
            }

            paginationControls.appendChild(pageButton);
        }
    }

    document.getElementById('userId').addEventListener('input', () => {
        inputEventCounter++;
        if (inputEventCounter === 3) {
            inputEventCounter = 0;
        }

        if (inputEventCounter === 0) {
            searchData('data-table');
        }
    });

    function searchData(tableId) {
        console.log('Search function called');

        const searchInput = document.getElementById('userId');
        const filter = searchInput.value.toUpperCase();
        console.log('Filter:', filter);

        const table = document.getElementById(tableId);
        const rows = table.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let shouldDisplay = false;

            for (let j = 0; j < cells.length; j++) {
                const cellText = cells[j].textContent || cells[j].innerText;

                if (cellText.toUpperCase().indexOf(filter) > -1) {
                    shouldDisplay = true;

                    const columnADataInput = document.getElementById('columnAData');
                    const columnAData = rows[i].getElementsByTagName('td')[2].textContent || rows[i].getElementsByTagName('td')[2].innerText;
                    columnADataInput.value = columnAData;

                    const columnBDataInput = document.getElementById('columnBData');
                    const columnBData = rows[i].getElementsByTagName('td')[3].textContent || rows[i].getElementsByTagName('td')[3].innerText;
                    columnBDataInput.value = columnBData;

                    console.log('i:', i, 'j:', j, 'columnAData:', columnAData, 'columnBData:', columnBData);

                    break;
                }
            }

            rows[i].style.display = shouldDisplay ? '' : 'none';
        }

        fetchData(tableId);
    }

    window.onload = function () {
        initializeLiff();
    };
</script>

<body>
    <div class="card">
        <input type="text" id="userId" name="userId" style="color: rgb(255, 255, 255);" />
        <br>
        <table style="background-color:#455089;color: white;">
            <td>ชื่อ</td>
            <td>รหัสพนักงาน</td>
        </table>
        <table id="additional-table" class="headertable2">
            <td>ชื่อ</td>
            <td>รหัสพนักงาน</td>
        </table>

        <br>
        <table class="headertable">
            <td>สถานะ</td>
            <td>หมายเหตุ</td>
            <td>วันที่</td>
            <td>เวลา</td>
        </table>
        <table id="data-table"></table>

        <div id="pagination-controls"></div>
    </div>
    

    <script>
        // Replace YOUR_API_KEY with your actual API key
        const apiKey = 'AIzaSyB89WSrfZKA_uP9UslXs8Bo7y90PYzbpD4';

        // Replace YOUR_SPREADSHEET_ID with your actual Google Sheets ID
        const spreadsheetId = '1DkCnmGVYMjf66tarSX1EA5zm1mDL_0ACYNx2AAa5J6g';

        // Google Sheets API endpoint
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/DATA?key=${apiKey}`;

        // Call the fetchData function when the page loads
        fetchData();
    </script>
</body>

</html>
