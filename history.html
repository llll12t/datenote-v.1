<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการบันทึก</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>

<style>
    input{
        border: 1px solid white;
    }
    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
        font-size: 0.7rem;
    }

    td,
    th {
        border: 1px solid #7d8ad5;
        text-align: left;
        padding: 8px;
		width:25%;
    }

    tr:nth-child(even) {
        background-color: #ffffff;
        font-size: 0.7rem;
    }
	label {
    font-size: 0.8rem;
    font-weight: bold;
    }
    .headertable{
    background-color: #213396;
    color: white;
    }
    .card{
        padding: 10px;
    }
</style>

<script>
  let inputEventCounter = 0;

  window.onload = function () {
      initializeLiff();
  };

  async function initializeLiff() {
      await liff.init({ liffId: '2002290922-yOznjZkQ' }); // Replace with your LIFF ID

      if (liff.isLoggedIn()) {
          getUserProfile();
      } else {
          liff.login();
      }
  }

  async function getUserProfile() {
      try {
          const profile = await liff.getProfile();
          document.getElementById('userId').value = profile.userId;
         
          // Trigger search when user ID is retrieved
          searchData();
      } catch (error) {
          console.error('Error getting profile data:', error);
      }
  }

  async function fetchData() {
    try {
        const values = await fetchValues();
        buildTable(values);

        // Trigger search only if the search input is not empty
        const searchInput = document.getElementById('userId');
        if (searchInput.value.trim() !== '') {
            searchData();
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

async function fetchValues() {
    const response = await fetch(apiUrl);
    const data = await response.json();
    return data.values;
}

function buildTable(values) {
    const table = document.getElementById('data-table');
    table.innerHTML = ''; // Clear previous data

    values.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        row.forEach((cell, cellIndex) => {
            const td = document.createElement('td');
            td.textContent = cell;

            // Hide specific columns
            const hiddenColumns = [0, 1, 2, 3, 8, 9, 10, 11];
            if (hiddenColumns.includes(cellIndex)) {
                td.style.display = 'none';
            }

            tr.appendChild(td);
        });
        table.appendChild(tr);

        // Hide the seventh row (index 6)
        if (rowIndex === 6) {
            tr.style.display = 'none';
        }
    });
}

  // Reset the counter after every third input event
  document.getElementById('userId').addEventListener('input', () => {
      inputEventCounter++;
      if (inputEventCounter === 3) {
          inputEventCounter = 0;
      }

      // Run the search logic every third input event
      if (inputEventCounter === 0) {
          searchData();
      }
  });

  function searchData() {
      const searchInput = document.getElementById('userId');
      const filter = searchInput.value.toUpperCase();
      const table = document.getElementById('data-table');
      const rows = table.getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
          const cells = rows[i].getElementsByTagName('td');
          let shouldDisplay = false;

          for (let j = 0; j < cells.length; j++) {
              const cellText = cells[j].textContent || cells[j].innerText;

              if (cellText.toUpperCase().indexOf(filter) > -1) {
                  shouldDisplay = true;

                  // Display data related to column A in the corresponding input field
                  const columnADataInput = document.getElementById('columnAData');
                  const columnAData =
                      rows[i].getElementsByTagName('td')[2].textContent || rows[i].getElementsByTagName('td')[2].innerText;
                  columnADataInput.value = columnAData;

                  // Display data related to column B in the corresponding input field
                  const columnBDataInput = document.getElementById('columnBData');
                  const columnBData =
                      rows[i].getElementsByTagName('td')[3].textContent || rows[i].getElementsByTagName('td')[3].innerText;
                  columnBDataInput.value = columnBData;

                  break;
              }
          }

          rows[i].style.display = shouldDisplay ? '' : 'none';
      }
  }
</script>

<body>
    <div class="card">
    <input type="text" id="userId" name="userId" value="U0f1478ccfc132f196c7e5c0b574b22bd"  style="color: black;" />
    <br>
    <label for="columnAData">ชื่อพนักงาน </label>
    <input type="text" id="columnAData" name="columnAData" />
    <br>
    <label for="columnBData">รหัสพนักงาน </label>
    <input type="text" class="form-control" id="columnBData" name="columnBData" />
    </div>
    <br>
	<table class="headertable">
		<td>สถานะ</td>
		<td>หมายเหตุ</td>
		<td>วันที่</td>
		<td>เวลา</td>
	</table>
    <table id="data-table"></table>
    <script>
        // Replace YOUR_API_KEY with your actual API key
        const apiKey = 'AIzaSyB89WSrfZKA_uP9UslXs8Bo7y90PYzbpD4';

        // Replace YOUR_SPREADSHEET_ID with your actual Google Sheets ID
        const spreadsheetId = '1DkCnmGVYMjf66tarSX1EA5zm1mDL_0ACYNx2AAa5J6g';

        // Google Sheets API endpoint
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/DATA?key=${apiKey}`;

        // Call the fetchData function when the page loads
        fetchData();
    </script>
</body>

</html>
