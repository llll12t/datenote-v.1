<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการบันทึก</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <!-- Add this line to include SweetAlert library -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<style>
    input {
        border: 1px solid white;
    }

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
        font-size: 0.7rem;
    }

    td,
    th {
        border: 1px solid #263585;
        text-align: left;
        padding: 8px;
        width: 25%;
    }

    tr:nth-child(even) {
        background-color: #ffffff;
        font-size: 0.7rem;
    }

    label {
        font-size: 0.8rem;
        font-weight: bold;
    }

    .headertable {
        background-color: #455089;
        color: white;
    }

    .headertable2 {
        background-color: #FFF;
        color: #000;
    }

    .card {
        padding: 10px;
    }

    #pagination-controls {
        margin-top: 10px;
    }

    #pagination-controls button {
        margin: 0 5px;
        padding: 5px 10px;
        cursor: pointer;
    }

    #pagination-controls button.active {
        background-color: #7d8ad5;
        color: white;
    }
</style>

<script>
    let inputEventCounter = 0;
    const itemsPerPage = 20; // Number of items to display per page
    let currentPage = 1;

    window.onload = function () {
        initializeLiff(), getUserProfile();
    };

    async function initializeLiff() {
        await liff.init({ liffId: '2002290922-yOznjZkQ' }); // Replace with your LIFF ID

        if (liff.isLoggedIn()) {
            getUserProfile();
        } else {
            liff.login();
        }
    }

    async function getUserProfile() {
        try {
            const profile = await liff.getProfile();
            document.getElementById('userId').value = profile.userId;

            // Trigger search when user ID is retrieved
            fetchData(); // Fetch data from the Google Sheets
            searchData(); // Perform initial search and display data
        } catch (error) {
            console.error('Error getting profile data:', error);
        }
    }

    async function fetchData() {
        try {
            const values = await fetchValues();
            const filteredValues = filterData(values); // Filter the data
            buildTable(filteredValues);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    async function fetchValues() {
        const response = await fetch(apiUrl);
        const data = await response.json();
        return data.values;
    }

    function filterData(values) {
        const searchInput = document.getElementById('userId');
        const filter = searchInput.value.toUpperCase();

        // Use filter to find rows that match the search criteria
        return values.filter((row) => {
            for (let j = 0; j < row.length; j++) {
                const cellText = row[j].toUpperCase();
                if (cellText.indexOf(filter) > -1) {
                    return true;
                }
            }
            return false;
        });
    }
    // Add a new constant for the additional table ID
    const additionalTableId = 'additional-table';

    async function fetchData() {
        try {
            // Show loading alert using SweetAlert
            Swal.fire({
                title: 'กำลังโหลดข้อมูล...',
                allowOutsideClick: false,
                onBeforeOpen: () => {
                    Swal.showLoading();
                }
            });

            const values = await fetchValues();
            const filteredValues = filterData(values);
            buildTable('data-table', filteredValues);
            buildAdditionalTable('additional-table', filteredValues);

            // Close loading alert after data is loaded
            Swal.close();
        } catch (error) {
            console.error('Error fetching data:', error);
            // You can also show an error alert using Swal.fire() here
        }
    }


    function buildAdditionalTable(tableId, values) {
        const table = document.getElementById(tableId);
        table.innerHTML = '';

        const row = values[0]; // Limit to the first row only
        const tr = document.createElement('tr');

        // Display only columns C and D
        for (let cellIndex = 2; cellIndex <= 3; cellIndex++) {
            const td = document.createElement('td');
            td.textContent = row[cellIndex];

            // You can apply additional styling or modifications here if needed

            tr.appendChild(td);
        }

        table.appendChild(tr);
    }

    function updatePaginationControls(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.addEventListener('click', () => {
                currentPage = i;
                fetchData();
            });

            // Highlight the current page button
            if (i === currentPage) {
                pageButton.classList.add('active');
            }

            paginationControls.appendChild(pageButton);
        }
    }

    // Reset the counter after every third input event
    document.getElementById('userId').addEventListener('input', () => {
        inputEventCounter++;
        if (inputEventCounter === 3) {
            inputEventCounter = 0;
        }

        // Run the search logic every third input event
        if (inputEventCounter === 0) {
            searchData();
        }
    });

 function buildTable(tableId, values) {
        const table = document.getElementById(tableId);
        table.innerHTML = '';

        const filteredValues = values.filter(row => {
            for (let j = 0; j < row.length; j++) {
                const cellText = row[j].toUpperCase();
                if (cellText.indexOf(filter) > -1) {
                    return true;
                }
            }
            return false;
        });

        // Show or hide the data-table based on the presence of matching data
        table.style.display = filteredValues.length > 0 ? '' : 'none';

        filteredValues.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            row.forEach((cell, cellIndex) => {
                const td = document.createElement('td');
                td.textContent = cell;

                const hiddenColumns = [0, 1, 2, 3, 8, 9, 10, 11];
                if (hiddenColumns.includes(cellIndex)) {
                    td.style.display = 'none';
                }

                tr.appendChild(td);
            });

            // Hide the seventh row (index 6)
            if (rowIndex === 6) {
                tr.style.display = 'none';
            }

            table.appendChild(tr);
        });

        updatePaginationControls(filteredValues.length);
    }

 // Modify the searchData function
function searchData() {
    const searchInput = document.getElementById('userId');
    const filter = searchInput.value.toUpperCase();

    const table = document.getElementById('data-table');
    const rows = table.getElementsByTagName('tr');
    let hasMatchingData = false;

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let shouldDisplay = false;

        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent || cells[j].innerText;

            if (cellText.toUpperCase().indexOf(filter) > -1) {
                shouldDisplay = true;
                hasMatchingData = true; // Set to true if there is a match
                break;
            }
        }

        rows[i].style.display = shouldDisplay ? '' : 'none';
    }

    // Show or hide the data-table based on the presence of matching data
    table.style.display = hasMatchingData ? '' : 'none';
}

</script>
<body>
    <div class="card">
        <input type="text" id="userId" name="userId" style="color: rgb(255, 255, 255);" />
        <br>
        <table style="background-color:#455089;color: white;">
            <td>ชื่อ</td>
            <td>รหัสพนักงาน</td>
        </table>
        <table id="additional-table" class="headertable2">
            <td>ชื่อ</td>
            <td>รหัสพนักงาน</td>
        </table>
        <br>
        <table class="headertable">
            <td>สถานะ</td>
            <td>หมายเหตุ</td>
            <td>วันที่</td>
            <td>เวลา</td>
        </table>
        <table id="data-table"></table>
        <!-- Add this div for pagination controls -->
        <div id="pagination-controls"></div>
    </div>
    <script>
        // Replace YOUR_API_KEY with your actual API key
        const apiKey = 'AIzaSyB89WSrfZKA_uP9UslXs8Bo7y90PYzbpD4';

        // Replace YOUR_SPREADSHEET_ID with your actual Google Sheets ID
        const spreadsheetId = '1DkCnmGVYMjf66tarSX1EA5zm1mDL_0ACYNx2AAa5J6g';

        // Google Sheets API endpoint
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/DATA?key=${apiKey}`;

        // Call the fetchData function when the page loads
        fetchData();
    </script>
</body>

</html>
